name: "Release"
on:
  workflow_call:
    secrets:
      TEST_PYPI_AUTH_TOKEN:
        required: true
      PYPI_AUTH_TOKEN:
        required: true

jobs:
  godot-distributable:
    runs-on: ubuntu-24.04
    steps:
        - uses: actions/checkout@v4
  
        - name: "Download all build artifacts"
          uses: actions/download-artifact@v4
          with:
            path: ./artifacts
  
        - name: "Make directory structure for release zip"
          run: |
            mkdir -p nobodywho-release/bin/addons/nobodywho
            # copy in nobodywho libs
            cp ./artifacts/*/*nobodywho-godot* ./nobodywho-release/bin/addons/nobodywho/
            # copy in gdextension metadata
            cp ./nobodywho/godot/nobodywho.gdextension ./nobodywho-release/bin/addons/nobodywho/
            cp ./assets/icon.svg ./nobodywho-release/bin/addons/nobodywho/
        - name: "Upload zipped godot build artifacts"
          uses: actions/upload-artifact@v4
          with:
            name: nobodywho-godot-all-platforms
            path: ./nobodywho-release

  create-github-release-godot:
    needs: [godot-distributable]
    if: startsWith(github.ref, 'refs/tags/nobodywho-godot-')
    runs-on: ubuntu-24.04
    steps:
      - name: "Download build artifacts"
        uses: actions/download-artifact@v4
        with:
          name: nobodywho-godot-all-platforms
          path: ./nobodywho-release-godot

      - name: "Make zip file"
        working-directory: ./nobodywho-release-godot
        run: zip -r "../nobodywho-godot-${{ github.ref_name }}.zip" ./**

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          files: "./nobodywho-godot-${{ github.ref_name }}.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-publish-wheels:
      runs-on: ubuntu-latest
      if: startsWith(github.ref, 'refs/tags/nobodywho-python-')
      steps:
        - name: Download all wheels
          uses: actions/download-artifact@v4
          with:
            pattern: nobodywho_python_*
            merge-multiple: true
            path: dist/

        - name: List wheels to upload
          run: ls -la dist/
        - uses: actions/setup-python@v6
          with:
            python-version: "3.13"
        
        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            python -m pip install twine

        - name: Publish to TestPyPI
          run: python -m twine upload --repository testpypi dist/*
          env:
            TWINE_USERNAME: __token__
            TWINE_PASSWORD: ${{ secrets.TEST_PYPI_AUTH_TOKEN }}

        - name: Download and pip install
          run: |
            python3 -m venv maturinvenv
            source ./maturinvenv/bin/activate
            python3 -m pip install --index-url https://test.pypi.org/simple/ nobodywho


  publish-wheels:
    needs:
      [
        test-publish-wheels
      ]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/nobodywho-python-')
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: nobodywho_python_*
          merge-multiple: true
          path: dist/

      - name: List wheels to upload
        run: ls -la dist/
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install twine

      - name: Publish to PyPI
        run: python -m twine upload dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_AUTH_TOKEN }}

  create-github-release-python:
    needs: [publish-wheels]
    if: startsWith(github.ref, 'refs/tags/nobodywho-python-')
    runs-on: ubuntu-latest
    steps:
      - name: "Download all Python wheels"
        uses: actions/download-artifact@v4
        with:
          pattern: nobodywho_python_*
          merge-multiple: true
          path: ./nobodywho-python-release

      - name: "List wheels to include in release"
        run: ls -la ./nobodywho-python-release/

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          files: ./nobodywho-python-release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-github-release-flutter:
    if: startsWith(github.ref, 'refs/tags/nobodywho-flutter-')
    runs-on: ubuntu-24.04
    steps:
      - name: "Download all Flutter artifacts"
        uses: actions/download-artifact@v4
        with:
          pattern: nobodywho-flutter-*
          merge-multiple: true
          path: ./nobodywho-flutter-release

      - name: "List artifacts to include in release"
        run: ls -la ./nobodywho-flutter-release/

      - name: "Zip XCFramework for release"
        working-directory: ./nobodywho-flutter-release
        run: |
          if [ -d "NobodyWhoFlutter.xcframework" ]; then
            zip -r "NobodyWhoFlutter.xcframework.zip" NobodyWhoFlutter.xcframework
            rm -rf NobodyWhoFlutter.xcframework
          fi

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          files: ./nobodywho-flutter-release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Publish to pub.dev"
        uses: "dart-lang/setup-dart/.github/workflows/publish.yml@v1"
        permissions:
          id-token: "write" # Required for authentication using OIDC
        with:
          working-directory: "nobodywho/flutter/nobodywho"
          environment: "pub.dev"
