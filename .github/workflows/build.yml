name: "Build"
on:
  workflow_call:
    inputs:
      upload_artifacts:
        type: boolean
        default: true

jobs:
  cargo-build-linux:
    strategy:
      fail-fast: false
      matrix:
        target:
          - "x86_64-unknown-linux-gnu"
          - "aarch64-unknown-linux-gnu"
        profile:
          - "debug"
          - "release"
        integration:
          - "godot"
          - "flutter"
        include:
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-24.04
          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-24.04-arm

    runs-on: ${{ matrix.runner }}
    env:
      RUSTFLAGS:  ${{ matrix.runner == 'ubuntu-24.04' && '-C target-cpu=x86-64-v3' || '' }}
    steps:
      - uses: actions/checkout@v4

      - name: "Cache Cargo Home"
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo
            nobodywho/target
          key: ${{ runner.os }}-cargo-home-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-home-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}-
      - name: "Setup rust toolchain"
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          . "$HOME/.cargo/env"
          rustup update stable
          rustup default stable
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: "Install Vulkan dependencies for x86 builds"
        if: matrix.target == 'x86_64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev cmake 
          sudo apt-get install libshaderc-dev libvulkan-dev glslc

      - name: "Setup Flutter SDK (manual for ARM64)"
        if: matrix.integration == 'flutter' && matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          git clone https://github.com/flutter/flutter.git -b 3.35.5 --depth 1
          echo "$PWD/flutter/bin" >> $GITHUB_PATH
          ./flutter/bin/flutter doctor
      
      - name: "Setup Flutter SDK (action for x64)"
        if: matrix.integration == 'flutter' && matrix.target == 'x86_64-unknown-linux-gnu'
        uses: flutter-actions/setup-flutter@v4
        with:
          channel: stable
          version: 3.35.5

      - name: "Compile for linux"
        run: cargo build -p nobodywho-${{ matrix.integration }} --verbose --target ${{ matrix.target }} ${{ matrix.profile == 'release' && '--release' || '' }} --locked
        working-directory: ./nobodywho

      - name: "Rename built file"
        run: |
          cp ./nobodywho/target/${{ matrix.target }}/${{ matrix.profile }}/libnobodywho_${{ matrix.integration }}.so ./libnobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}.so

      - name: "Upload build artifact"
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}
          path: ./libnobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}.so

  cargo-build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - "x86_64-pc-windows-msvc"
        profile:
          - "debug"
          - "release"
        integration:
          - "godot"
          - "flutter"
    env:
      RUSTFLAGS: >-
        -l Advapi32
        -C target-cpu=x86-64-v3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: "Cache Cargo Home"
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo
            nobodywho/target
          key: ${{ runner.os }}-cargo-home-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-home-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}-
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1.2.5
        with:
          vulkan_version: 1.3.296.0
          cache: true
          install_runtime: true
          stripdown: true

      - name: Install Ninja
        run: choco install ninja

      - name: Setup Flutter SDK
        if: matrix.integration == 'flutter'
        uses: flutter-actions/setup-flutter@v4
        with:
          channel: stable
          version: 3.35.5

      - name: Build with Cargo
        # move things into a shortly-named dir in the root, because windows is made by fuckwits who think limiting paths to 260 chars is ok
        run: |
          mv ./nobodywho/* C:/
          cd C:/
          # Use an even shorter target directory to avoid path length issues with git dependencies
          cargo build -p nobodywho-${{ matrix.integration }} --target ${{ matrix.target }} --verbose ${{ matrix.profile == 'release' && '--release' || '' }} --locked --target-dir C:/t
        env:
          RUSTFLAGS: >-
            -l Advapi32
            -C debuginfo=0
          # Use Ninja generator instead of Visual Studio generator.
          # This fixes a CMake ExternalProject issue where vulkan-shaders-gen's
          # install step fails to find cmake_install.cmake with the VS generator.
          # Ninja's simpler build structure avoids this problem entirely.
          CMAKE_GENERATOR: "Ninja"

      - name: "Rename built files"
        run: |
          cp C:/t/${{ matrix.target }}/${{ matrix.profile }}/nobodywho_${{ matrix.integration }}.dll ./libnobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}.dll
          cp C:/t/${{ matrix.target }}/${{ matrix.profile }}/nobodywho_${{ matrix.integration }}.pdb ./libnobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}.pdb

      - name: "Upload build artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}
          path: |
            ./libnobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}.dll
            ./libnobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}.pdb

  cargo-build-macos:
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        target:
          - "x86_64-apple-darwin"
          - "aarch64-apple-darwin"
          - "aarch64-apple-ios"
            # these two are for running in an ios simulator
          - "aarch64-apple-ios-sim"
          - "x86_64-apple-ios"
        profile:
          - "debug"
          - "release"
        integration:
          - "godot"
          - "flutter"
    steps:
      - uses: actions/checkout@v4
      - run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          . "$HOME/.cargo/env"
          rustup update stable
          rustup default stable
          rustup target add ${{ matrix.target }}
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Setup Flutter SDK
        if: matrix.integration == 'flutter'
        uses: flutter-actions/setup-flutter@v4
        with:
          channel: stable
          version: 3.35.5

      # name: SSHX for debugging
      # if: matrix.target == 'aarch64-apple-ios'
      # run: "curl -sSf https://sshx.io/get | sh -s run"

      - run: cargo build -p nobodywho-${{ matrix.integration }} --verbose --target ${{ matrix.target }} ${{ matrix.profile == 'release' && '--release' || '' }} --locked
        working-directory: ./nobodywho
        env:
          IPHONEOS_DEPLOYMENT_TARGET: "18.5"

      - name: "Rename built file"
        run: |
          # .dylib: dynamically linkable shared object
          cp ./nobodywho/target/${{ matrix.target }}/${{ matrix.profile }}/libnobodywho_${{ matrix.integration }}.dylib ./libnobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}.dylib
          if [ "${{ matrix.integration }}" == "flutter" ]; then
            # .a: statically linkable ar archive of .o objects (used to build xcframework)
            cp ./nobodywho/target/${{ matrix.target }}/${{ matrix.profile }}/libnobodywho_${{ matrix.integration }}.a ./libnobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}.a
          fi

      - name: "Upload build artifact"
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}
          # wildcard path to match both .dylib and .a
          path: ./libnobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}.*

  # builds an "xcframework"
  # which is an apple thing that contains binaries for multiple systems
  build-flutter-xcframework:
    runs-on: macos-15
    needs: [cargo-build-macos]
    steps:
      - uses: actions/checkout@v4

      - name: "Download all build artifacts"
        uses: actions/download-artifact@v4
        with:
          pattern: nobodywho-flutter-*-apple-*
          merge-multiple: true

      - name: Create headers
        run: |
          mkdir -p headers
          cp nobodywho/flutter/nobodywho_flutter/ios/Classes/binding.h headers/
          cat > headers/module.modulemap << 'EOF'
          module CBinding {
              header "binding.h"
              export *
          }
          EOF

      - name: Build XCFramework
        # commands taken from here:
        # https://cjycode.com/flutter_rust_bridge/manual/integrate/library/platform-setup/ios-and-macos
        run: |
          LIBNAME=libnobodywho_flutter.a

          # ios sim stuff
          mkdir ios-sim-lipo
          lipo -create -output ./ios-sim-lipo/$LIBNAME \
            libnobodywho-flutter-aarch64-apple-ios-sim-release.a \
            libnobodywho-flutter-x86_64-apple-ios-release.a \

          # macos universal binary
          mkdir macos-lipo
          lipo -create -output macos-lipo/$LIBNAME \
            libnobodywho-flutter-aarch64-apple-darwin-release.a \
            libnobodywho-flutter-x86_64-apple-darwin-release.a

          # rename libs so linker can find them
          mkdir aarch64-macos
          cp libnobodywho-flutter-aarch64-apple-darwin-release.a ./aarch64-macos/$LIBNAME
          mkdir aarch64-ios
          cp libnobodywho-flutter-aarch64-apple-ios-release.a ./aarch64-ios/$LIBNAME

          # both of those things, plus the actual ios build
          # with both universal binaries and the direct ones
          #
          # including this *and* the universal binary makes xcodebuild sad
          # -library "aarch64-macos/$LIBNAME" \
          xcodebuild -create-xcframework \
                  -library "ios-sim-lipo/$LIBNAME" \
                  -headers "headers" \
                  -library "macos-lipo/$LIBNAME" \
                  -headers "headers" \
                  -library "aarch64-ios/$LIBNAME" \
                  -headers "headers" \
                  -output NobodyWhoFlutter.xcframework

      - name: "Upload build artifact"
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho-flutter-xcframework
          path: ./NobodyWhoFlutter.xcframework

  cargo-build-android:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        target:
          - "aarch64-linux-android"
          - "x86_64-linux-android"
        profile:
          - "debug"
          - "release"
        integration:
          - "godot"
          - "flutter"
    steps:
      - uses: actions/checkout@v4

      - name: "Cache Cargo Home"
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo
            nobodywho/target
          key: ${{ runner.os }}-cargo-home-${{ matrix.target }}-${{ matrix.profile }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-home-${{ matrix.target }}-${{ matrix.profile }}-
      - name: "Setup rust toolchain"
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          . "$HOME/.cargo/env"
          rustup update stable
          rustup default stable
          rustup target add ${{ matrix.target }}
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: "Install distro dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev cmake libshaderc-dev libvulkan-dev glslc gcc-multilib

      - name: "Install Android NDK"
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r28
          add-to-path: false

      - name: Setup Flutter SDK
        if: matrix.integration == 'flutter'
        uses: flutter-actions/setup-flutter@v4
        with:
          channel: stable
          version: 3.35.5

      - name: "Compile for android"
        run: cargo build -p nobodywho-${{ matrix.integration }} --verbose --target ${{ matrix.target }} ${{ matrix.profile == 'release' && '--release' || '' }}
        working-directory: ./nobodywho
        env:
          ANDROID_NDK: "${{ steps.setup-ndk.outputs.ndk-path }}"
          # aarch64 (arm64-v8a)
          CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang"
          CARGO_TARGET_AARCH64_LINUX_ANDROID_AR: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          CC_aarch64_linux_android: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android31-clang"
          AR_aarch64_linux_android: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          # x86_64
          CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android34-clang"
          CARGO_TARGET_X86_64_LINUX_ANDROID_AR: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          CC_x86_64_linux_android: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android31-clang"
          AR_x86_64_linux_android: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"

        # XXX: .so files for android in godot MUST start with "lib"
      - name: "Rename built file"
        run: cp ./nobodywho/target/${{ matrix.target }}/${{ matrix.profile }}/libnobodywho_${{ matrix.integration }}.so ./libnobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}.so

      - name: "Upload build artifact"
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}
          path: ./libnobodywho-${{ matrix.integration }}-${{ matrix.target }}-${{ matrix.profile }}.so
