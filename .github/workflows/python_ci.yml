name: "python_ci"

on: 
  workflow_call:
    

permissions:
  contents: read

jobs:
  static-checks:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"

      - name: Install dependencies
        working-directory: ./nobodywho/python
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev cmake libshaderc-dev libvulkan-dev glslc
          uv venv && uv sync

      - name: Regenerate stubs
        working-directory: ./nobodywho/python
        run: cargo build && cargo run --bin make_stubs

      - name: Lint check
        working-directory: ./nobodywho/python
        run: uvx ruff check

      - name: Check for uncommitted changes
        working-directory: ./nobodywho/python
        run: |
          if ! git diff --quiet; then
            echo "âŒ Generated stubs are outdated. Run the generator and commit results."
            git --no-pager diff
            exit 1
          fi

      - name: Type check
        working-directory: ./nobodywho/python
        run: uvx ty check

  linux-build:
    # Build inside manylinux_2_34 container for glibc 2.34 compatibility
    # This targets glibc version 2.34 which covers most distros going back to 2021
    # See: https://github.com/mayeut/pep600_compliance?tab=readme-ov-file#distro-compatibility
    
    strategy:
      fail-fast: false
      matrix:
        runner: [ubuntu-24.04, ubuntu-24.04-arm]
        include:
          - runner: ubuntu-24.04
            manylinux_target: manylinux_2_34_x86_64 
          - runner: ubuntu-24.04-arm
            manylinux_target: manylinux_2_34_aarch64
    runs-on: ${{ matrix.runner }}
    container:
      image: quay.io/pypa/${{ matrix.manylinux_target }}
    env:
      RUSTFLAGS: ${{ matrix.runner == 'ubuntu-24.04' && '-C target-cpu=x86-64-v3' || '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source "$HOME/.cargo/env"
      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1.2.5
        with:
          vulkan_version: 1.4.304.0
          cache: true

      - name: Install build dependencies
        run: |
          yum install -y clang cmake wget tar gzip python3-pip
          pip3 install maturin auditwheel

      - name: Setup Vulkan SDK (manual for ARM64)
        if: matrix.runner == 'ubuntu-24.04-arm'
        run: |
          SDK_VERSION="1.4.304.0"
          SDK_URL="https://github.com/jakoch/vulkan-sdk-arm/releases/download/${SDK_VERSION}/vulkansdk-ubuntu-22.04-arm-${SDK_VERSION}.tar.xz"

          # Download and extract Vulkan SDK
          cd /tmp
          wget -q "$SDK_URL" -O vulkan-sdk.tar.xz
          tar -xf vulkan-sdk.tar.xz

          # ARM64 SDK has architecture-specific subdirectory
          SDK_DIR="/tmp/$(ls -d */ | grep -E '^[0-9]' | head -n1)"
          VULKAN_SDK="${SDK_DIR%/}/aarch64"

          # Persist to GitHub environment
          echo "VULKAN_SDK=$VULKAN_SDK" >> $GITHUB_ENV
          echo "$VULKAN_SDK/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=$VULKAN_SDK/lib" >> $GITHUB_ENV

          # Build shaderc to get glslc compiler (not included in ARM64 SDK)
          yum install -y python3 git
          cd /tmp
          git clone --depth 1 --branch v2024.3 https://github.com/google/shaderc.git
          cd shaderc
          ./utils/git-sync-deps

          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX="$VULKAN_SDK" \
                -DSHADERC_SKIP_TESTS=ON \
                -DSHADERC_SKIP_EXAMPLES=ON \
                ..
          make -j$(nproc)

          # Copy glslc to SDK bin directory
          cp glslc/glslc "$VULKAN_SDK/bin/" || { echo "ERROR: glslc not found"; exit 1; }


      - name: Build linux python wheel
        run: |
          source "$HOME/.cargo/env"
          maturin build --verbose --release --locked
        working-directory: ./nobodywho/python

      - name: Repair wheel to use manylinux
        # auditwheel bundles external libraries and verifies manylinux compliance
        run: auditwheel repair --plat ${{ matrix.manylinux_target }} nobodywho/target/wheels/nobodywho*.whl

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho_python_linux_${{ matrix.manylinux_target }}
          path: ./wheelhouse/nobodywho*.whl


  windows-build:
    strategy:
      fail-fast: false
      matrix:
        target:
          - "x86_64-pc-windows-msvc"
    runs-on: windows-latest
    env:
      RUSTFLAGS: -l Advapi32 -C target-cpu=x86-64-v3
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.target }}
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - run: pip install maturin
      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1.2.5
        with:
          vulkan_version: 1.4.304.0
          install_runtime: false
          cache: true
          stripdown: true
      - name: Install Ninja
        run: choco install ninja
      
      - name: "Build windows python wheel"
        run: |
          mv ./nobodywho/* C:/
          New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force
          git config --system core.longpaths true
          cd C:/
          cd python
          maturin build --verbose --release --locked --target ${{ matrix.target }}
        env:
          # Use Ninja generator instead of Visual Studio generator.
          # This fixes a CMake ExternalProject issue where vulkan-shaders-gen's
          # install step fails to find cmake_install.cmake with the VS generator.
          # Ninja's simpler build structure avoids this problem entirely.
          CMAKE_GENERATOR: "Ninja"
      - name: "Upload wheel artifact"
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho_python_windows_${{ matrix.target }}
          path: C:/target/wheels/nobodywho*.whl

  mac-os-build:
    runs-on: macos-latest
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - run: brew install maturin
      - name: "Build macos python wheel"
        run: maturin build --verbose --release --locked --target aarch64-apple-darwin
        working-directory: ./nobodywho/python

      - name: "Upload build artifact"
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho_python_macos
          path: ./nobodywho/target/wheels/nobodywho*.whl

  linux-pytest:
    needs: [linux-build]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"
      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: nobodywho_python_linux_manylinux_2_34_x86_64
          path: ./wheels
      - name: Download test models
        run: |
          mkdir -p models
          curl -L --fail --progress-bar https://huggingface.co/bartowski/Qwen_Qwen3-0.6B-GGUF/resolve/main/Qwen_Qwen3-0.6B-Q4_K_M.gguf -o models/Qwen_Qwen3-0.6B-Q4_K_M.gguf
          curl -L --fail --progress-bar https://huggingface.co/CompendiumLabs/bge-small-en-v1.5-gguf/resolve/main/bge-small-en-v1.5-q8_0.gguf -o models/bge-small-en-v1.5-q8_0.gguf
          curl -L --fail --progress-bar https://huggingface.co/gpustack/bge-reranker-v2-m3-GGUF/resolve/main/bge-reranker-v2-m3-Q8_0.gguf -o models/bge-reranker-v2-m3-Q8_0.gguf
      - name: Set up virtualenv and install dependencies
        working-directory: ./nobodywho/python
        run: |
          uv venv
          # install deps - and not nobodywho-python - into the venv
          uv sync --no-install-project --group dev
          # install nobodywho from pre-built wheel
          uv pip install ../../wheels/nobodywho*manylinux*x86*.whl
      - name: Run pytest
        working-directory: ./nobodywho/python
        env:
          TEST_MODEL: ${{ github.workspace }}/models/Qwen_Qwen3-0.6B-Q4_K_M.gguf
          TEST_EMBEDDINGS_MODEL: ${{ github.workspace }}/models/bge-small-en-v1.5-q8_0.gguf
          TEST_CROSSENCODER_MODEL: ${{ github.workspace }}/models/bge-reranker-v2-m3-Q8_0.gguf
        run: |
          source .venv/bin/activate
          # python bindings tests
          python3 -m pytest
          # docs tests
          python3 -m pytest --markdown-docs ../../docs --markdown-docs-syntax=superfences

  linux-tool-calling-tests:
    needs: [linux-build]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        model:
          - name: Qwen3
            file: Qwen_Qwen3-0.6B-Q4_K_M.gguf
            url: https://huggingface.co/bartowski/Qwen_Qwen3-0.6B-GGUF/resolve/main/Qwen_Qwen3-0.6B-Q4_K_M.gguf
            format: Qwen3
          - name: FunctionGemma
            file: functiongemma-270m-it-BF16.gguf
            url: https://huggingface.co/unsloth/functiongemma-270m-it-GGUF/resolve/main/functiongemma-270m-it-BF16.gguf
            format: FunctionGemma
          - name: Ministral3
            file: mistralai_Ministral-3-3B-Instruct-2512-Q6_K_L.gguf
            url: https://huggingface.co/bartowski/mistralai_Ministral-3-3B-Instruct-2512-GGUF/resolve/main/mistralai_Ministral-3-3B-Instruct-2512-Q6_K_L.gguf
            format: Ministral3

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"

      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: nobodywho_python_linux_manylinux_2_34_x86_64
          path: ./wheels

      - name: Download ${{ matrix.model.name }} model
        run: |
          mkdir -p models
          curl -L --fail --progress-bar \
            ${{ matrix.model.url }} \
            -o models/${{ matrix.model.file }}
          echo "Model size:"
          ls -lh models/${{ matrix.model.file }}

      - name: Set up virtualenv and install dependencies
        working-directory: ./nobodywho/python
        run: |
          uv venv
          uv sync --no-install-project --group dev
          uv pip install ../../wheels/nobodywho*manylinux*x86*.whl

      - name: Run tool calling tests with ${{ matrix.model.name }}
        working-directory: ./nobodywho/python
        env:
          TEST_MODEL: ${{ github.workspace }}/models/${{ matrix.model.file }}
        run: |
          source .venv/bin/activate
          python3 -m pytest tests/test_tool_calling.py -v --tb=short

      - name: Display test summary
        if: always()
        run: |
          echo "### Tool Calling Tests: ${{ matrix.model.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Model: ${{ matrix.model.file }}" >> $GITHUB_STEP_SUMMARY
          echo "- Format: ${{ matrix.model.format }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY


  linux-pip-install-test:
    needs: [linux-build]
    strategy:
      fail-fast: false
      matrix:
        model: [Qwen, Gemma]
        runner: [ubuntu-24.04, ubuntu-24.04-arm]
        include:
          - model: Qwen
            model_name: Qwen3-0.6B-UD-Q6_K_XL.gguf
            model_iterations: 10
            model_link: https://huggingface.co/unsloth/Qwen3-0.6B-GGUF/resolve/main/Qwen3-0.6B-UD-Q6_K_XL.gguf
          - model: Gemma
            model_name: google_gemma-3-4b-it-Q4_1.gguf
            model_iterations: 10
            model_link: https://huggingface.co/bartowski/google_gemma-3-4b-it-GGUF/resolve/main/google_gemma-3-4b-it-Q4_1.gguf
          - runner: ubuntu-24.04
            manylinux_target: manylinux_2_34_x86_64 
          - runner: ubuntu-24.04-arm
            manylinux_target: manylinux_2_34_aarch64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - name: "Download wheel"
        uses: actions/download-artifact@v4
        with:
          name: nobodywho_python_linux_${{ matrix.manylinux_target }}
          path: ./wheels

      - name: Install wheel
        run: |
          python3 -m venv maturinvenv
          source ./maturinvenv/bin/activate
          pip install wheels/nobodywho*.whl

      - name: Download models
        run: |
          mkdir -p linux/nobodypython/models
          curl -L --fail --progress-bar ${{ matrix.model_link }} -o linux/nobodypython/models/${{ matrix.model_name }}

      - name: Run small model in python
        run: |
          source ./maturinvenv/bin/activate
          chmod +x nobodywho/python/tests/test_reliability.sh
          bash nobodywho/python/tests/test_reliability.sh -n ${{ matrix.model_iterations }} nobodywho/python/examples/small_model_demo.py "linux/nobodypython/models/${{ matrix.model_name }}"

  windows-pip-install-test:
    needs: [windows-build]
    strategy:
      fail-fast: false
      matrix:
        runner: [windows-latest]
        model: [Gemma]
        include:
          - model: Gemma
            model_name: google_gemma-3-4b-it-Q4_1.gguf
            model_iterations: 10
            model_link: https://huggingface.co/bartowski/google_gemma-3-4b-it-GGUF/resolve/main/google_gemma-3-4b-it-Q4_1.gguf
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - name: "Download wheel"
        uses: actions/download-artifact@v4
        with:
          name: nobodywho_python_windows_${{ matrix.target }}
          path: ./wheels
      - name: Install wheel
        run: |
          python -m venv maturinvenv
          maturinvenv/Scripts/activate
          pip install (Get-ChildItem ./wheels/nobodywho*.whl).FullName

      - name: Download models
        run: |
          mkdir -p D:/a/nobodywho/nobodywho/windows/nobodywho_python/models
          pip install -U "huggingface_hub"
          Invoke-WebRequest ${{ matrix.model_link }} -OutFile "D:/a/nobodywho/nobodywho/windows/nobodywho_python/models/${{ matrix.model_name}}"

      - name: Run small model in python
        run: |
          maturinvenv/Scripts/activate
          ./nobodywho/python/tests/test_reliability.ps1 -ScriptPath "D:/a/nobodywho/nobodywho/nobodywho/python/examples/small_model_demo.py" -Iterations ${{ matrix.model_iterations }} "D:/a/nobodywho/nobodywho/windows/nobodywho_python/models/${{ matrix.model_name }}"

  mac-os-pip-install-test:
    needs: [mac-os-build]
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        model: [Gemma]
        include:
          - model: Gemma
            model_name: google_gemma-3-4b-it-Q4_1.gguf
            model_iterations: 10
            model_link: https://huggingface.co/bartowski/google_gemma-3-4b-it-GGUF/resolve/main/google_gemma-3-4b-it-Q4_1.gguf
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: "Download wheel"
        uses: actions/download-artifact@v4

      - name: Install wheel
        run: |
          python3 -m venv maturinvenv
          source ./maturinvenv/bin/activate
          pip install nobodywho_python_macos/nobodywho*macosx*.whl

      - name: Download models
        run: |
          mkdir -p macos/nobodypython/models
          curl -L --fail --progress-bar ${{ matrix.model_link }} -o macos/nobodypython/models/${{ matrix.model_name }}

      - name: Run small model in python
        run: |
          source ./maturinvenv/bin/activate
          python -c "import nobodywho; print('Import successful')"
          chmod +x nobodywho/python/tests/test_reliability.sh
          bash nobodywho/python/tests/test_reliability.sh -n ${{ matrix.model_iterations }} nobodywho/python/examples/small_model_demo.py "macos/nobodypython/models/${{ matrix.model_name }}"
  
  
