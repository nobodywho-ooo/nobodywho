name: "python_ci"

on: 
  workflow_call:
    

permissions:
  contents: read

jobs:
  static-checks:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"

      - name: Install dependencies
        working-directory: ./nobodywho/python
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev cmake libshaderc-dev libvulkan-dev glslc
          uv venv && uv sync

      - name: Regenerate stubs
        working-directory: ./nobodywho/python
        run: cargo build && cargo run --bin make_stubs

      - name: Lint check
        working-directory: ./nobodywho/python
        run: uvx ruff check

      - name: Check for uncommitted changes
        working-directory: ./nobodywho/python
        run: |
          if ! git diff --quiet; then
            echo "❌ Generated stubs are outdated. Run the generator and commit results."
            git --no-pager diff
            exit 1
          fi

      - name: Type check
        working-directory: ./nobodywho/python
        run: uvx ty check

  linux-build:
    # Build inside manylinux_2_34 container for glibc 2.34 compatibility
    # This targets glibc version 2.34 which covers most distros going back to 2021
    # See: https://github.com/mayeut/pep600_compliance?tab=readme-ov-file#distro-compatibility
    
    strategy:
      fail-fast: false
      matrix:
        runner: [ubuntu-24.04, ubuntu-24.04-arm]
        include:
          - runner: ubuntu-24.04
            manylinux_target: manylinux_2_34_x86_64 
          - runner: ubuntu-24.04-arm
            manylinux_target: manylinux_2_34_aarch64
    runs-on: ${{ matrix.runner }}
    container:
      image: quay.io/pypa/${{ matrix.manylinux_target }}
    env:
      RUSTFLAGS: ${{ matrix.runner == 'ubuntu-24.04' && '-C target-cpu=x86-64-v3' || '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source "$HOME/.cargo/env"
      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1.2.5
        with:
          vulkan_version: 1.4.304.0
          cache: true

      - name: Setup Vulkan SDK environment
        run: |
          # Debug: Show current VULKAN_SDK value
          echo "Current VULKAN_SDK: ${VULKAN_SDK:-not set}"

          # Search for Vulkan SDK installation
          echo "Searching for Vulkan SDK..."
          find /opt -name glslc 2>/dev/null || echo "glslc not found in /opt"
          find /usr -name glslc 2>/dev/null || echo "glslc not found in /usr"

          # Check if VULKAN_SDK is already set and valid
          if [ -n "$VULKAN_SDK" ] && [ -d "$VULKAN_SDK" ]; then
            echo "Using VULKAN_SDK from environment: $VULKAN_SDK"
            if [ -f "$VULKAN_SDK/bin/glslc" ]; then
              echo "glslc found at $VULKAN_SDK/bin/glslc"
              echo "VULKAN_SDK=$VULKAN_SDK" >> $GITHUB_ENV
              echo "$VULKAN_SDK/bin" >> $GITHUB_PATH
              echo "VK_LAYER_PATH=$VULKAN_SDK/etc/vulkan/explicit_layer.d" >> $GITHUB_ENV
            else
              echo "Warning: glslc not found in VULKAN_SDK bin directory"
            fi
          else
            echo "VULKAN_SDK not set or invalid, searching common paths..."
            # Try common installation paths
            for path in /opt/vulkan-sdk /usr/local /opt/VulkanSDK/* /github/home/.vulkan-sdk; do
              echo "Checking $path"
              if [ -d "$path/bin" ] && [ -f "$path/bin/glslc" ]; then
                echo "Found Vulkan SDK at $path"
                echo "VULKAN_SDK=$path" >> $GITHUB_ENV
                echo "$path/bin" >> $GITHUB_PATH
                echo "VK_LAYER_PATH=$path/etc/vulkan/explicit_layer.d" >> $GITHUB_ENV
                break
              fi
            done
          fi

          # Verify glslc is available
          echo "Checking for glslc in PATH..."
          which glslc || echo "WARNING: glslc not found in PATH"

      - name: Install build dependencies
        run: |
          # Install basic build tools
          yum install -y clang cmake wget tar gzip python3-pip

          # Check if glslc is available
          if ! which glslc; then
            echo "glslc not found, downloading pre-built Vulkan SDK..."

            # Determine architecture
            ARCH=$(uname -m)
            echo "Architecture: $ARCH"

            if [ "$ARCH" = "x86_64" ]; then
              # For x86_64, use official Vulkan SDK
              SDK_VERSION="1.4.304.0"
              SDK_URL="https://sdk.lunarg.com/sdk/download/${SDK_VERSION}/linux/vulkansdk-linux-${ARCH}-${SDK_VERSION}.tar.xz"
            elif [ "$ARCH" = "aarch64" ]; then
              # For ARM64, use jakoch's pre-built SDK
              SDK_VERSION="1.4.304.0"
              # Use ubuntu-22.04 build for better glibc compatibility with manylinux
              SDK_URL="https://github.com/jakoch/vulkan-sdk-arm/releases/download/${SDK_VERSION}/vulkansdk-ubuntu-22.04-arm-${SDK_VERSION}.tar.xz"
            else
              echo "Unsupported architecture: $ARCH"
              exit 1
            fi

            # Download and extract Vulkan SDK
            cd /tmp
            wget -q "$SDK_URL" -O vulkan-sdk.tar.xz
            tar -xf vulkan-sdk.tar.xz
            SDK_DIR="/tmp/$(ls -d */ | grep -E '^[0-9]' | head -n1)"
            SDK_DIR="${SDK_DIR%/}"  # Remove trailing slash

            # For ARM64, the SDK has an architecture-specific subdirectory
            if [ "$ARCH" = "aarch64" ] && [ -d "$SDK_DIR/aarch64" ]; then
              echo "Found aarch64 subdirectory, using that as VULKAN_SDK"
              SDK_DIR="$SDK_DIR/aarch64"
            fi

            # Set up environment
            export VULKAN_SDK="$SDK_DIR"
            export PATH="$VULKAN_SDK/bin:$PATH"
            export LD_LIBRARY_PATH="$VULKAN_SDK/lib:${LD_LIBRARY_PATH:-}"

            # Persist to GitHub environment
            echo "VULKAN_SDK=$VULKAN_SDK" >> $GITHUB_ENV
            echo "$VULKAN_SDK/bin" >> $GITHUB_PATH
            echo "LD_LIBRARY_PATH=$VULKAN_SDK/lib:${LD_LIBRARY_PATH:-}" >> $GITHUB_ENV

            # Verify installation
            echo "Using VULKAN_SDK: $VULKAN_SDK"
            ls -la "$VULKAN_SDK/bin/" || echo "SDK bin directory not found"

            # Check if glslc exists, if not build shaderc
            if [ ! -f "$VULKAN_SDK/bin/glslc" ]; then
              echo "glslc not found in Vulkan SDK, building shaderc..."

              # Install build dependencies for shaderc
              yum install -y python3 git

              # Build shaderc (which includes glslc)
              cd /tmp
              git clone --depth 1 --branch v2024.3 https://github.com/google/shaderc.git
              cd shaderc
              ./utils/git-sync-deps

              mkdir -p build
              cd build
              cmake -DCMAKE_BUILD_TYPE=Release \
                    -DCMAKE_INSTALL_PREFIX="$VULKAN_SDK" \
                    -DSHADERC_SKIP_TESTS=ON \
                    -DSHADERC_SKIP_EXAMPLES=ON \
                    ..
              make -j$(nproc)

              # Find and copy glslc binary (might be in glslc/ or glslc/src/)
              if [ -f glslc/glslc ]; then
                cp glslc/glslc "$VULKAN_SDK/bin/"
              elif [ -f glslc/src/glslc ]; then
                cp glslc/src/glslc "$VULKAN_SDK/bin/"
              else
                echo "ERROR: glslc binary not found!"
                echo "Searching for glslc..."
                find . -name glslc -type f
                exit 1
              fi

              echo "glslc installed to $VULKAN_SDK/bin/glslc"
            fi

            # Verify glslc is now available
            "$VULKAN_SDK/bin/glslc" --version || echo "ERROR: glslc still not working"
          else
            echo "glslc found: $(which glslc)"
            glslc --version
          fi

          # Install Python build tools
          pip3 install maturin auditwheel


      - name: Verify Vulkan SDK environment
        run: |
          echo "=== Vulkan SDK Environment ==="
          echo "VULKAN_SDK: ${VULKAN_SDK:-not set}"
          echo "PATH: $PATH"
          echo "LD_LIBRARY_PATH: ${LD_LIBRARY_PATH:-not set}"

          if [ -n "$VULKAN_SDK" ]; then
            echo ""
            echo "=== Vulkan SDK Contents ==="
            ls -la "$VULKAN_SDK/" || echo "VULKAN_SDK directory not found"
            echo ""
            echo "=== Vulkan SDK bin ==="
            ls -la "$VULKAN_SDK/bin/" || echo "bin directory not found"
            echo ""
            echo "=== Vulkan SDK lib ==="
            ls -la "$VULKAN_SDK/lib/" || echo "lib directory not found"
            echo ""
            echo "=== Vulkan SDK include ==="
            ls -la "$VULKAN_SDK/include/" || echo "include directory not found"

            # Check for required files
            echo ""
            echo "=== Checking required files ==="
            test -f "$VULKAN_SDK/bin/glslc" && echo "✓ glslc found" || echo "✗ glslc NOT found"
            test -f "$VULKAN_SDK/lib/libvulkan.so" && echo "✓ libvulkan.so found" || echo "✗ libvulkan.so NOT found (checking lib64)"
            test -f "$VULKAN_SDK/lib64/libvulkan.so" && echo "✓ libvulkan.so found in lib64" || echo "✗ libvulkan.so NOT found in lib64"
            test -d "$VULKAN_SDK/include/vulkan" && echo "✓ vulkan headers found" || echo "✗ vulkan headers NOT found"
          fi

          # Try to run glslc
          echo ""
          echo "=== Testing glslc ==="
          which glslc && glslc --version || echo "glslc not in PATH"

      - name: Build linux python wheel
        run: |
          source "$HOME/.cargo/env"

          # Set CMake hints for Vulkan if SDK is available
          if [ -n "$VULKAN_SDK" ]; then
            export CMAKE_PREFIX_PATH="$VULKAN_SDK:${CMAKE_PREFIX_PATH:-}"
            export Vulkan_INCLUDE_DIR="$VULKAN_SDK/include"
            # Check both lib and lib64
            if [ -d "$VULKAN_SDK/lib64" ]; then
              export Vulkan_LIBRARY="$VULKAN_SDK/lib64/libvulkan.so"
            else
              export Vulkan_LIBRARY="$VULKAN_SDK/lib/libvulkan.so"
            fi
            export Vulkan_glslc_EXECUTABLE="$VULKAN_SDK/bin/glslc"

            echo "CMake Vulkan hints:"
            echo "  CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH"
            echo "  Vulkan_INCLUDE_DIR=$Vulkan_INCLUDE_DIR"
            echo "  Vulkan_LIBRARY=$Vulkan_LIBRARY"
            echo "  Vulkan_glslc_EXECUTABLE=$Vulkan_glslc_EXECUTABLE"
          fi

          maturin build --verbose --release --locked
        working-directory: ./nobodywho/python

      - name: Repair wheel to use manylinux
        # auditwheel bundles external libraries and verifies manylinux compliance
        run: auditwheel repair --plat ${{ matrix.manylinux_target }} nobodywho/target/wheels/nobodywho*.whl

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho_python_linux_${{ matrix.manylinux_target }}
          path: ./wheelhouse/nobodywho*.whl


  windows-build:
    strategy:
      fail-fast: false
      matrix:
        target:
          - "x86_64-pc-windows-msvc"
    runs-on: windows-latest
    env:
      RUSTFLAGS: -l Advapi32 -C target-cpu=x86-64-v3
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.target }}
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - run: pip install maturin
      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1.2.5
        with:
          vulkan_version: 1.4.304.0
          install_runtime: false
          cache: true
          stripdown: true
      - name: Install Ninja
        run: choco install ninja
      
      - name: "Build windows python wheel"
        run: |
          mv ./nobodywho/* C:/
          New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force
          git config --system core.longpaths true
          cd C:/
          cd python
          maturin build --verbose --release --locked --target ${{ matrix.target }}
        env:
          # Use Ninja generator instead of Visual Studio generator.
          # This fixes a CMake ExternalProject issue where vulkan-shaders-gen's
          # install step fails to find cmake_install.cmake with the VS generator.
          # Ninja's simpler build structure avoids this problem entirely.
          CMAKE_GENERATOR: "Ninja"
      - name: "Upload wheel artifact"
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho_python_windows_${{ matrix.target }}
          path: C:/target/wheels/nobodywho*.whl

  mac-os-build:
    runs-on: macos-latest
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - run: brew install maturin
      - name: "Build macos python wheel"
        run: maturin build --verbose --release --locked --target aarch64-apple-darwin
        working-directory: ./nobodywho/python

      - name: "Upload build artifact"
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho_python_macos
          path: ./nobodywho/target/wheels/nobodywho*.whl

  linux-pytest:
    needs: [linux-build]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"
      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: nobodywho_python_linux_manylinux_2_34_x86_64
          path: ./wheels
      - name: Download test models
        run: |
          mkdir -p models
          curl -L --fail --progress-bar https://huggingface.co/bartowski/Qwen_Qwen3-0.6B-GGUF/resolve/main/Qwen_Qwen3-0.6B-Q4_K_M.gguf -o models/Qwen_Qwen3-0.6B-Q4_K_M.gguf
          curl -L --fail --progress-bar https://huggingface.co/CompendiumLabs/bge-small-en-v1.5-gguf/resolve/main/bge-small-en-v1.5-q8_0.gguf -o models/bge-small-en-v1.5-q8_0.gguf
          curl -L --fail --progress-bar https://huggingface.co/gpustack/bge-reranker-v2-m3-GGUF/resolve/main/bge-reranker-v2-m3-Q8_0.gguf -o models/bge-reranker-v2-m3-Q8_0.gguf
      - name: Set up virtualenv and install dependencies
        working-directory: ./nobodywho/python
        run: |
          uv venv
          # install deps - and not nobodywho-python - into the venv
          uv sync --no-install-project --group dev
          # install nobodywho from pre-built wheel
          uv pip install ../../wheels/nobodywho*manylinux*x86*.whl
      - name: Run pytest
        working-directory: ./nobodywho/python
        env:
          TEST_MODEL: ${{ github.workspace }}/models/Qwen_Qwen3-0.6B-Q4_K_M.gguf
          TEST_EMBEDDINGS_MODEL: ${{ github.workspace }}/models/bge-small-en-v1.5-q8_0.gguf
          TEST_CROSSENCODER_MODEL: ${{ github.workspace }}/models/bge-reranker-v2-m3-Q8_0.gguf
        run: |
          source .venv/bin/activate
          # python bindings tests
          python3 -m pytest
          # docs tests
          python3 -m pytest --markdown-docs ../../docs --markdown-docs-syntax=superfences



  linux-pip-install-test:
    needs: [linux-build]
    strategy:
      fail-fast: false
      matrix:
        model: [Qwen, Gemma]
        runner: [ubuntu-24.04, ubuntu-24.04-arm]
        include:
          - model: Qwen
            model_name: Qwen3-0.6B-UD-Q6_K_XL.gguf
            model_iterations: 10
            model_link: https://huggingface.co/unsloth/Qwen3-0.6B-GGUF/resolve/main/Qwen3-0.6B-UD-Q6_K_XL.gguf
          - model: Gemma
            model_name: google_gemma-3-4b-it-Q4_1.gguf
            model_iterations: 10
            model_link: https://huggingface.co/bartowski/google_gemma-3-4b-it-GGUF/resolve/main/google_gemma-3-4b-it-Q4_1.gguf
          - runner: ubuntu-24.04
            manylinux_target: manylinux_2_34_x86_64 
          - runner: ubuntu-24.04-arm
            manylinux_target: manylinux_2_34_aarch64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - name: "Download wheel"
        uses: actions/download-artifact@v4
        with:
          name: nobodywho_python_linux_${{ matrix.manylinux_target }}
          path: ./wheels

      - name: Install wheel
        run: |
          python3 -m venv maturinvenv
          source ./maturinvenv/bin/activate
          pip install wheels/nobodywho*.whl

      - name: Download models
        run: |
          mkdir -p linux/nobodypython/models
          curl -L --fail --progress-bar ${{ matrix.model_link }} -o linux/nobodypython/models/${{ matrix.model_name }}

      - name: Run small model in python
        run: |
          source ./maturinvenv/bin/activate
          chmod +x nobodywho/python/tests/test_reliability.sh
          bash nobodywho/python/tests/test_reliability.sh -n ${{ matrix.model_iterations }} nobodywho/python/examples/small_model_demo.py "linux/nobodypython/models/${{ matrix.model_name }}"

  windows-pip-install-test:
    needs: [windows-build]
    strategy:
      fail-fast: false
      matrix:
        runner: [windows-latest]
        model: [Gemma]
        include:
          - model: Gemma
            model_name: google_gemma-3-4b-it-Q4_1.gguf
            model_iterations: 10
            model_link: https://huggingface.co/bartowski/google_gemma-3-4b-it-GGUF/resolve/main/google_gemma-3-4b-it-Q4_1.gguf
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - name: "Download wheel"
        uses: actions/download-artifact@v4
        with:
          name: nobodywho_python_windows_${{ matrix.target }}
          path: ./wheels
      - name: Install wheel
        run: |
          python -m venv maturinvenv
          maturinvenv/Scripts/activate
          pip install (Get-ChildItem ./wheels/nobodywho*.whl).FullName

      - name: Download models
        run: |
          mkdir -p D:/a/nobodywho/nobodywho/windows/nobodywho_python/models
          pip install -U "huggingface_hub"
          Invoke-WebRequest ${{ matrix.model_link }} -OutFile "D:/a/nobodywho/nobodywho/windows/nobodywho_python/models/${{ matrix.model_name}}"

      - name: Run small model in python
        run: |
          maturinvenv/Scripts/activate
          ./nobodywho/python/tests/test_reliability.ps1 -ScriptPath "D:/a/nobodywho/nobodywho/nobodywho/python/examples/small_model_demo.py" -Iterations ${{ matrix.model_iterations }} "D:/a/nobodywho/nobodywho/windows/nobodywho_python/models/${{ matrix.model_name }}"

  mac-os-pip-install-test:
    needs: [mac-os-build]
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        model: [Gemma]
        include:
          - model: Gemma
            model_name: google_gemma-3-4b-it-Q4_1.gguf
            model_iterations: 10
            model_link: https://huggingface.co/bartowski/google_gemma-3-4b-it-GGUF/resolve/main/google_gemma-3-4b-it-Q4_1.gguf
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: "Download wheel"
        uses: actions/download-artifact@v4

      - name: Install wheel
        run: |
          python3 -m venv maturinvenv
          source ./maturinvenv/bin/activate
          pip install nobodywho_python_macos/nobodywho*macosx*.whl

      - name: Download models
        run: |
          mkdir -p macos/nobodypython/models
          curl -L --fail --progress-bar ${{ matrix.model_link }} -o macos/nobodypython/models/${{ matrix.model_name }}

      - name: Run small model in python
        run: |
          source ./maturinvenv/bin/activate
          python -c "import nobodywho; print('Import successful')"
          chmod +x nobodywho/python/tests/test_reliability.sh
          bash nobodywho/python/tests/test_reliability.sh -n ${{ matrix.model_iterations }} nobodywho/python/examples/small_model_demo.py "macos/nobodypython/models/${{ matrix.model_name }}"
  
  
