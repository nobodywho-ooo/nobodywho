name: "python_ci"

on: 
  workflow_call:
    secrets:
      TEST_PYPI_AUTH_TOKEN:
        required: true
      PYPI_AUTH_TOKEN:
        required: true

permissions:
  contents: read

jobs:
  static-checks:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"

      - name: Install dependencies
        working-directory: ./nobodywho/python
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev cmake libshaderc-dev libvulkan-dev glslc
          uv venv && uv sync

      - name: Regenerate stubs
        working-directory: ./nobodywho/python
        run: cargo build && cargo run --bin make_stubs

      - name: Format check
        working-directory: ./nobodywho/python
        run: |
          uvx ruff format ./nobodywho.pyi
          uvx ruff format --check .

      - name: Lint check
        working-directory: ./nobodywho/python
        run: uvx ruff check

      - name: Check for uncommitted changes
        working-directory: ./nobodywho/python
        run: |
          if ! git diff --quiet; then
            echo "âŒ Generated stubs are outdated. Run the generator and commit results."
            git --no-pager diff
            exit 1
          fi

      - name: Type check
        working-directory: ./nobodywho/python
        run: uvx ty check

  linux-build:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        profile:
          - "debug"
    env:
      RUSTFLAGS: >-
        -C target-cpu=x86-64-v3
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - run: pip install maturin auditwheel
      - name: Install distro dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev cmake libshaderc-dev libvulkan-dev glslc

      - name: Build linux python wheel
        run: maturin build --verbose ${{ matrix.profile == 'release' && '--release' || '' }} --locked
        working-directory: ./nobodywho/python

      - name: Repair wheel to use manylinux
        run: auditwheel repair nobodywho/target/wheels/nobodywho*.whl

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho_python_linux
          path: ./wheelhouse/nobodywho*.whl

  windows-build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - "x86_64-pc-windows-msvc"
        profile:
          - "debug"
    env:
      RUSTFLAGS: >-
        -l Advapi32
        -C target-cpu=x86-64-v3
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.target }}
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - run: pip install maturin
      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1.2.5
        with:
          vulkan_version: 1.3.296.0
          cache: true
          install_runtime: true
          stripdown: true
      - name: Install Ninja
        run: choco install ninja
      - name: "Build windows python wheel"
        run: |
          mv ./nobodywho/* C:/
          New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force
          git config --system core.longpaths true
          cd C:/
          cd python
          maturin build --verbose ${{ matrix.profile == 'release' && '--release' || '' }} --locked --target ${{ matrix.target }}
        env:
          # Use Ninja generator instead of Visual Studio generator.
          # This fixes a CMake ExternalProject issue where vulkan-shaders-gen's
          # install step fails to find cmake_install.cmake with the VS generator.
          # Ninja's simpler build structure avoids this problem entirely.
          CMAKE_GENERATOR: "Ninja"
      - name: "Upload wheel artifact"
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho_python_windows
          path: C:/target/wheels/nobodywho*.whl

  mac-os-build:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        profile:
          # - "release"
          - "debug"
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - run: brew install maturin
      - name: "Build macos python wheel"
        run: maturin build --verbose ${{ matrix.profile == 'release' && '--release' || '' }} --locked --target aarch64-apple-darwin
        working-directory: ./nobodywho/python

      - name: "Upload build artifact"
        uses: actions/upload-artifact@v4
        with:
          name: nobodywho_python_macos
          path: ./nobodywho/target/wheels/nobodywho*.whl

  linux-pytest:
    needs: [linux-build]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"
      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: nobodywho_python_linux
          path: ./wheels
      - name: Download test models
        run: |
          mkdir -p models
          curl -L --fail --progress-bar https://huggingface.co/bartowski/Qwen_Qwen3-0.6B-GGUF/resolve/main/Qwen_Qwen3-0.6B-Q4_K_M.gguf -o models/Qwen_Qwen3-0.6B-Q4_K_M.gguf
          curl -L --fail --progress-bar https://huggingface.co/CompendiumLabs/bge-small-en-v1.5-gguf/resolve/main/bge-small-en-v1.5-q8_0.gguf -o models/bge-small-en-v1.5-q8_0.gguf
          curl -L --fail --progress-bar https://huggingface.co/gpustack/bge-reranker-v2-m3-GGUF/resolve/main/bge-reranker-v2-m3-Q8_0.gguf -o models/bge-reranker-v2-m3-Q8_0.gguf
      - name: Set up virtualenv and install dependencies
        working-directory: ./nobodywho/python
        run: |
          uv venv
          # install deps - and not nobodywho-python - into the venv
          uv sync --no-install-project --group dev
          # install nobodywho from pre-built wheel
          uv pip install ../../wheels/nobodywho*manylinux*x86*.whl
      - name: Run pytest
        working-directory: ./nobodywho/python
        env:
          TEST_MODEL: ${{ github.workspace }}/models/Qwen_Qwen3-0.6B-Q4_K_M.gguf
          TEST_EMBEDDINGS_MODEL: ${{ github.workspace }}/models/bge-small-en-v1.5-q8_0.gguf
          TEST_CROSSENCODER_MODEL: ${{ github.workspace }}/models/bge-reranker-v2-m3-Q8_0.gguf
        run: |
          source .venv/bin/activate
          # python bindings tests
          python3 -m pytest
          # docs tests
          python3 -m pytest --markdown-docs ../../docs --markdown-docs-syntax=superfences



  linux-pip-install-test:
    needs: [linux-build]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        model: [Qwen, Gemma]
        include:
          - model: Qwen
            model_name: Qwen3-0.6B-UD-Q6_K_XL.gguf
            model_iterations: 10
            model_link: https://huggingface.co/unsloth/Qwen3-0.6B-GGUF/resolve/main/Qwen3-0.6B-UD-Q6_K_XL.gguf
          - model: Gemma
            model_name: google_gemma-3-4b-it-Q4_1.gguf
            model_iterations: 10
            model_link: https://huggingface.co/bartowski/google_gemma-3-4b-it-GGUF/resolve/main/google_gemma-3-4b-it-Q4_1.gguf
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - name: "Download wheel"
        uses: actions/download-artifact@v4

      - name: Install wheel
        run: |
          python3 -m venv maturinvenv
          source ./maturinvenv/bin/activate
          pip install nobodywho_python_linux/nobodywho*manylinux*x86*.whl

      - name: Download models
        run: |
          mkdir -p linux/nobodypython/models
          curl -L --fail --progress-bar ${{ matrix.model_link }} -o linux/nobodypython/models/${{ matrix.model_name }}

      - name: Run small model in python
        run: |
          source ./maturinvenv/bin/activate
          chmod +x nobodywho/python/tests/test_reliability.sh
          bash nobodywho/python/tests/test_reliability.sh -n ${{ matrix.model_iterations }} nobodywho/python/examples/small_model_demo.py "linux/nobodypython/models/${{ matrix.model_name }}"

  windows-pip-install-test:
    runs-on: windows-latest
    needs: [windows-build]
    strategy:
      fail-fast: false
      matrix:
        # model: [Qwen, Gemma]
        model: [Gemma]
        include:
          # XXX: this is broken somewhy...
          #- model: Qwen
          #  model_name: Qwen3-0.6B-UD-Q6_K_XL.gguf
          #  model_iterations: 10
          #  model_link: https://huggingface.co/unsloth/Qwen3-0.6B-GGUF/resolve/main/Qwen3-0.6B-UD-Q6_K_XL.gguf
          - model: Gemma
            model_name: google_gemma-3-4b-it-Q4_1.gguf
            model_iterations: 10
            model_link: https://huggingface.co/bartowski/google_gemma-3-4b-it-GGUF/resolve/main/google_gemma-3-4b-it-Q4_1.gguf
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1.2.5
        with:
          vulkan_version: 1.3.296.0
          cache: true
          install_runtime: true
      - name: "Download wheel"
        uses: actions/download-artifact@v4
      - name: Install wheel
        run: |
          python -m venv maturinvenv
          maturinvenv/Scripts/activate
          pip install (Get-ChildItem D:/a/nobodywho/nobodywho/nobodywho_python_windows/nobodywho*win*.whl).FullName

      - name: Download models
        run: |
          mkdir -p D:/a/nobodywho/nobodywho/windows/nobodywho_python/models
          pip install -U "huggingface_hub"
          Invoke-WebRequest ${{ matrix.model_link }} -OutFile "D:/a/nobodywho/nobodywho/windows/nobodywho_python/models/${{ matrix.model_name}}"

      - name: Run small model in python
        run: |
          maturinvenv/Scripts/activate
          ./nobodywho/python/tests/test_reliability.ps1 -ScriptPath "D:/a/nobodywho/nobodywho/nobodywho/python/examples/small_model_demo.py" -Iterations ${{ matrix.model_iterations }} "D:/a/nobodywho/nobodywho/windows/nobodywho_python/models/${{ matrix.model_name }}"

  mac-os-pip-install-test:
    needs: [mac-os-build]
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        model: [Gemma]
        include:
          - model: Gemma
            model_name: google_gemma-3-4b-it-Q4_1.gguf
            model_iterations: 10
            model_link: https://huggingface.co/bartowski/google_gemma-3-4b-it-GGUF/resolve/main/google_gemma-3-4b-it-Q4_1.gguf
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: "Download wheel"
        uses: actions/download-artifact@v4

      - name: Install wheel
        run: |
          python3 -m venv maturinvenv
          source ./maturinvenv/bin/activate
          pip install nobodywho_python_macos/nobodywho*macosx*.whl

      - name: Download models
        run: |
          mkdir -p macos/nobodypython/models
          curl -L --fail --progress-bar ${{ matrix.model_link }} -o macos/nobodypython/models/${{ matrix.model_name }}

      - name: Run small model in python
        run: |
          source ./maturinvenv/bin/activate
          python -c "import nobodywho; print('Import successful')"
          chmod +x nobodywho/python/tests/test_reliability.sh
          bash nobodywho/python/tests/test_reliability.sh -n ${{ matrix.model_iterations }} nobodywho/python/examples/small_model_demo.py "macos/nobodypython/models/${{ matrix.model_name }}"
  
  test-publish-wheels:
    needs:
      [
        linux-pip-install-test,
        windows-pip-install-test,
        mac-os-pip-install-test,
        linux-pytest,
      ]
    runs-on: ubuntu-latest
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: nobodywho_python_*
          merge-multiple: true
          path: dist/

      - name: List wheels to upload
        run: ls -la dist/
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install twine

      - name: Publish to TestPyPI
        run: python -m twine upload --repository testpypi dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_AUTH_TOKEN }}

      - name: Download and pip install
        run: |
          python3 -m venv maturinvenv
          source ./maturinvenv/bin/activate
          python3 -m pip install --index-url https://test.pypi.org/simple/ nobodywho


  publish-wheels:
    needs:
      [
        test-publish-wheels
      ]
    runs-on: ubuntu-latest
    # if: startsWith(github.ref, 'refs/tags/nobodywho-python-')
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: nobodywho_python_*
          merge-multiple: true
          path: dist/

      - name: List wheels to upload
        run: ls -la dist/
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install twine

      - name: Publish to TestPyPI
        run: python -m twine upload dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_AUTH_TOKEN }}
